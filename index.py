import pygame as py
from matlab_data import Matlab
import os
from time import time
import sys
from random import uniform
from math import degrees, atan
from components.cloud import Cloud
from components.functions import draw_text
from components.input import TextInput
from components.button import Button

py.init()

screenWidth = 1280
screenHeight = 720

screen = py.display.set_mode((screenWidth, screenHeight))

volcanPngRaw = py.image.load(os.path.join("assets", "f1-logo.png"))
volcanPng = py.transform.scale(volcanPngRaw, (1300/6, 723/6))#.convert()

forest = py.image.load(os.path.join("assets", "forest.png"))

py.display.set_icon(volcanPng)
py.display.set_caption("F1")

clock = py.time.Clock()

class GameState():
    def __init__(self):
        """ print("cargando matlab...")
        self.matlab = Matlab()
        self.posX, self.posY = self.matlab.getPositions()
        print("Matlab listo") """
        self.posX = [2.0,3.0,4.0,5.0,6.0,7.0,8.0,9.0,10.0,11.0,12.0,13.0,14.0,15.0,16.0,17.0,18.0,19.0,20.0,21.0,22.0,23.0,24.0,25.0,26.0,27.0,28.0,29.0,30.0,31.0,32.0,33.0,34.0,35.0,36.0,37.0,38.0,39.0,40.0,41.0,42.0,43.0,44.0,45.0,46.0,47.0,48.0,49.0,50.0,51.0,52.0,53.0,54.0,55.0,56.0,57.0,58.0,59.0,60.0,61.0,62.0,63.0,64.0,65.0,66.0,67.0,68.0,69.0,70.0,71.0,72.0,73.0,74.0,75.0,76.0,77.0,78.0,79.0,80.0,81.0,82.0,83.0,84.0,85.0,86.0,87.0,88.0,89.0,90.0,91.0,92.0,93.0,94.0,95.0,96.0,97.0,98.0,99.0,100.0,101.0,102.0,103.0,104.0,105.0,106.0,107.0,108.0,109.0,110.0,111.0,112.0,113.0,114.0,115.0,116.0,117.0,118.0,119.0,120.0,121.0,122.0,123.0,124.0,125.0,126.0,127.0,128.0,129.0,130.0,131.0,132.0,133.0,134.0,135.0,136.0,137.0,138.0,139.0,140.0,141.0,142.0,143.0,144.0,145.0,146.0,147.0,148.0,149.0,150.0,151.0,152.0,153.0,154.0,155.0,156.0,157.0,158.0,159.0,160.0,161.0,162.0,163.0,164.0,165.0,166.0,167.0,168.0,169.0,170.0,171.0,172.0,173.0,174.0,175.0,176.0,177.0,178.0,179.0,180.0,181.0,182.0,183.0,184.0,185.0,186.0,187.0,188.0,189.0,190.0,191.0,192.0,193.0,194.0,195.0,196.0,197.0,198.0,199.0,200.0,201.0,202.0,203.0,204.0,205.0,206.0,207.0,208.0,209.0,210.0,211.0,212.0,213.0,214.0,215.0,216.0,217.0,218.0,219.0,220.0,221.0,222.0,223.0,224.0,225.0,226.0,227.0,228.0,229.0,230.0,231.0,232.0,233.0,234.0,235.0,236.0,237.0,238.0,239.0,240.0,241.0,242.0,243.0,244.0,245.0,246.0,247.0,248.0,249.0,250.0,251.0,252.0,253.0,254.0,255.0,256.0,257.0,258.0,259.0,260.0,261.0,262.0,263.0,264.0,265.0,266.0,267.0,268.0,269.0,270.0,271.0,272.0,273.0,274.0,275.0,276.0,277.0,278.0,279.0,280.0,281.0,282.0,283.0,284.0,285.0,286.0,287.0,288.0,289.0,290.0,291.0,292.0,293.0,294.0,295.0,296.0,297.0,298.0,299.0,300.0,301.0,302.0,303.0,304.0,305.0,306.0,307.0,308.0,309.0,310.0,311.0,312.0,313.0,314.0,315.0,316.0,317.0,318.0,319.0,320.0,321.0,322.0,323.0,324.0,325.0,326.0,327.0,328.0,329.0,330.0,331.0,332.0,333.0,334.0,335.0,336.0,337.0,338.0,339.0,340.0,341.0,342.0,343.0,344.0,345.0,346.0,347.0,348.0,349.0,350.0,351.0,352.0,353.0,354.0,355.0,356.0,357.0,358.0,359.0,360.0,361.0,362.0,363.0,364.0,365.0,366.0,367.0,368.0,369.0,370.0,371.0,372.0,373.0,374.0,375.0,376.0,377.0,378.0,379.0,380.0,381.0,382.0,383.0,384.0,385.0,386.0,387.0,388.0,389.0,390.0,391.0,392.0,393.0,394.0,395.0,396.0,397.0,398.0,399.0,400.0,401.0,402.0,403.0,404.0,405.0,406.0,407.0,408.0,409.0,410.0,411.0,412.0,413.0,414.0,415.0,416.0,417.0,418.0,419.0,420.0,421.0,422.0,423.0,424.0,425.0,426.0,427.0,428.0,429.0,430.0,431.0,432.0,433.0,434.0,435.0,436.0,437.0,438.0,439.0,440.0,441.0,442.0,443.0,444.0,445.0,446.0,447.0,448.0,449.0,450.0,451.0,452.0,453.0,454.0,455.0,456.0,457.0,458.0,459.0,460.0,461.0,462.0,463.0,464.0,465.0,466.0,467.0,468.0,469.0,470.0,471.0,472.0,473.0,474.0,475.0,476.0,477.0,478.0,479.0,480.0,481.0,482.0,483.0,484.0,485.0,486.0,487.0,488.0,489.0,490.0,491.0,492.0,493.0,494.0,495.0,496.0,497.0,498.0,499.0,500.0]
        self.posY = [300.0,296.1689453125,292.3904113769531,288.6641845703125,284.99005126953125,281.3677978515625,277.7971496582031,274.2779541015625,270.8099365234375,267.3928527832031,264.02655029296875,260.71075439453125,257.44525146484375,254.22979736328125,251.064208984375,247.94822692871094,244.8816375732422,241.86422729492188,238.895751953125,235.9759979248047,233.10475158691406,230.28176879882812,227.50682067871094,224.7797088623047,222.10018920898438,219.46804809570312,216.883056640625,214.34498596191406,211.85362243652344,209.40872192382812,207.01007080078125,204.65745544433594,202.3506317138672,200.0894012451172,197.87350463867188,195.70274353027344,193.57688903808594,191.49571228027344,189.458984375,187.46649169921875,185.51800537109375,183.61331176757812,181.7521514892578,179.93434143066406,178.1596221923828,176.42779541015625,174.73863220214844,173.09188842773438,171.48736572265625,169.92481994628906,168.40403747558594,166.92478942871094,165.4868621826172,164.0900115966797,162.73402404785156,161.41867065429688,160.14373779296875,158.90899658203125,157.71421813964844,156.55917358398438,155.4436492919922,154.36740112304688,153.33023071289062,152.3319091796875,151.3721923828125,150.45086669921875,149.56771850585938,148.72251892089844,147.91502380371094,147.14503479003906,146.4123077392578,145.7166290283203,145.05776977539062,144.4355010986328,143.849609375,143.29986572265625,142.78604125976562,142.30792236328125,141.8652801513672,141.45787048339844,141.0854949951172,140.7479248046875,140.44493103027344,140.17628479003906,139.94175720214844,139.7411346435547,139.57420349121094,139.44070434570312,139.3404541015625,139.273193359375,139.23870849609375,139.23680114746094,139.26719665527344,139.3297119140625,139.4241180419922,139.5501708984375,139.70765686035156,139.89634704589844,140.11602783203125,140.366455078125,140.64743041992188,140.95870971679688,141.30007934570312,141.6713104248047,142.07215881347656,142.50244140625,142.96189880371094,143.45033264160156,143.9674835205078,144.51316833496094,145.08712768554688,145.6891632080078,146.31903076171875,146.9765167236328,147.66139221191406,148.37342834472656,149.1124267578125,149.8781280517578,150.67031860351562,151.48878479003906,152.3332977294922,153.20361328125,154.09954833984375,155.02084350585938,155.96726989746094,156.93862915039062,157.9346923828125,158.95521545410156,160.0,161.0688018798828,162.16140747070312,163.27757263183594,164.41709899902344,165.57974243164062,166.76528930664062,167.97352600097656,169.20419311523438,170.4571075439453,171.7320098876953,173.02870178222656,174.34693908691406,175.68650817871094,177.04718017578125,178.42872619628906,179.8309326171875,181.25357055664062,182.69642639160156,184.1592559814453,185.64183044433594,187.14395141601562,188.66537475585938,190.2058868408203,191.7652587890625,193.34326171875,194.93968200683594,196.5542755126953,198.1868438720703,199.83714294433594,201.5049591064453,203.19004821777344,204.8922119140625,206.61122131347656,208.34683227539062,210.0988311767578,211.86700439453125,213.651123046875,215.45094299316406,217.26626586914062,219.0968475341797,220.94247436523438,222.80291748046875,224.67796325683594,226.56736755371094,228.47091674804688,230.38839721679688,232.31956481933594,234.2642059326172,236.2220916748047,238.1929931640625,240.17669677734375,242.17298889160156,244.18161010742188,246.20236206054688,248.23501586914062,250.27932739257812,252.33511352539062,254.40211486816406,256.4801025390625,258.5688781738281,260.668212890625,262.77789306640625,264.89764404296875,267.02728271484375,269.16656494140625,271.3153076171875,273.4732360839844,275.64013671875,277.8157958984375,280.0,282.1925048828125,284.3930969238281,286.6015319824219,288.817626953125,291.0411071777344,293.2717590332031,295.5093994140625,297.7537841796875,300.004638671875,302.2618103027344,304.5250549316406,306.7940979003906,309.06878662109375,311.3488464355469,313.6340637207031,315.9242248535156,318.2191162109375,320.51849365234375,322.8221435546875,325.12982177734375,327.4413146972656,329.75640869140625,332.0748596191406,334.3964538574219,336.7209777832031,339.0481872558594,341.37786865234375,343.70977783203125,346.0437316894531,348.3794860839844,350.716796875,353.0554504394531,355.3952331542969,357.73590087890625,360.0772705078125,362.4190673828125,364.7611083984375,367.1031188964844,369.4449462890625,371.7862854003906,374.126953125,376.46673583984375,378.805419921875,381.1427307128906,383.47845458984375,385.8124084472656,388.1443176269531,390.4739990234375,392.80120849609375,395.125732421875,397.44732666015625,399.7657775878906,402.0808410644531,404.392333984375,406.70001220703125,409.003662109375,411.3030090332031,413.597900390625,415.8880615234375,418.17327880859375,420.4533386230469,422.7279968261719,424.9970703125,427.2602844238281,429.5174255371094,431.768310546875,434.0126647949219,436.2502746582031,438.48095703125,440.70440673828125,442.9205017089844,445.1289367675781,447.3294982910156,449.5220031738281,451.7061767578125,453.8818359375,456.0487365722656,458.2066345214844,460.3553466796875,462.49462890625,464.624267578125,466.7440185546875,468.8536682128906,470.9529724121094,473.041748046875,475.1197204589844,477.18670654296875,479.2424621582031,481.2867736816406,483.31939697265625,485.34014892578125,487.3487548828125,489.3450012207031,491.3287048339844,493.2995910644531,495.2574462890625,497.20208740234375,499.13323974609375,501.0506896972656,502.9542236328125,504.8435974121094,506.7186279296875,508.57904052734375,510.4246520996094,512.2552490234375,514.0704956054688,515.8703002929688,517.6544189453125,519.4225463867188,521.174560546875,522.91015625,524.629150390625,526.3312377929688,528.016357421875,529.6841430664062,531.3344116210938,532.9669189453125,534.5814819335938,536.1779174804688,537.755859375,539.3152465820312,540.855712890625,542.3771362304688,543.8792114257812,545.3617553710938,546.8245849609375,548.2673950195312,549.6900024414062,551.0921630859375,552.4736938476562,553.8343505859375,555.1738891601562,556.4920654296875,557.7887573242188,559.0635986328125,560.3164672851562,561.547119140625,562.7553100585938,563.9408569335938,565.1034545898438,566.2429809570312,567.3590698242188,568.45166015625,569.5204467773438,570.565185546875,571.585693359375,572.5817260742188,573.5530395507812,574.4994506835938,575.4207153320312,576.3165893554688,577.1868896484375,578.0313110351562,578.8497924804688,579.6419067382812,580.4075927734375,581.1465454101562,581.8585205078125,582.5433959960938,583.2008666992188,583.8306884765625,584.4326782226562,585.006591796875,585.55224609375,586.0693359375,586.5577392578125,587.0171508789062,587.4473876953125,587.8482055664062,588.2194213867188,588.5607299804688,588.8719482421875,589.1528930664062,589.4032592773438,589.6229248046875,589.8115844726562,589.968994140625,590.0950317382812,590.1893920898438,590.2518310546875,590.2822265625,590.2802124023438,590.2457275390625,590.1784057617188,590.078125,589.944580078125,589.777587890625,589.576904296875,589.3423461914062,589.0736694335938,588.7706298828125,588.4329833984375,588.060546875,587.6531372070312,587.21044921875,586.7322387695312,586.2183837890625,585.6685791015625,585.0826416015625,584.4603271484375,583.8014526367188,583.105712890625,582.3729248046875,581.6028442382812,580.7953491210938,579.9500732421875,579.06689453125,578.1455078125,577.1857299804688,576.1873168945312,575.150146484375,574.0738525390625,572.958251953125,571.8031616210938,570.6083374023438,569.37353515625,568.0985107421875,566.7831420898438,565.4270629882812,564.0301513671875,562.5921630859375,561.1128540039062,559.592041015625,558.0294189453125,556.4248657226562,554.778076171875,553.0888061523438,551.35693359375,549.5821533203125,547.7642822265625,545.903076171875,543.9983520507812,542.0497436523438,540.0571899414062,538.0204467773438,535.939208984375,533.8132934570312,531.6424560546875,529.426513671875,527.1652221679688,524.8583374023438,522.505615234375,520.10693359375,517.6619873046875,515.1705322265625,512.6323852539062,510.0473327636719,507.4151306152344,504.7355651855469,502.00836181640625,499.2333679199219,496.4103088378906,493.53900146484375,490.6191711425781,487.650634765625,484.6331481933594,481.5664978027344,478.4504699707031,475.2847900390625,472.06927490234375,468.8037109375,465.4878234863281,462.1214599609375,458.7043151855469,455.2362365722656,451.7169494628906,448.146240234375,444.52392578125,440.8497009277344,437.1234130859375,433.3448181152344,429.513671875,425.6297607421875,421.69287109375,417.7027893066406,413.65924072265625,409.5620422363281,405.4109802246094,401.2057800292969,396.9462585449219,392.6321716308594,388.2633056640625,383.8394470214844,379.3603515625,374.8257751464844,370.2355651855469,365.58941650390625,360.88714599609375,356.1285095214844,351.31329345703125,346.4412841796875,341.5122375488281,336.5259704589844,331.482177734375,326.3807373046875,321.2213134765625,316.0037841796875,310.7278747558594,305.3933410644531,300.0]
        self.state = "intro"

        self.clouds = [Cloud(), Cloud(), Cloud(), Cloud()]

        self.first = [False, False, False]
        self.lastTime = time()
        self.dt = time() - self.lastTime
        self.font = "assets/Pixellari.ttf"

        self.active = False
        self.carRaw = py.image.load(os.path.join("assets", "f1-car.png"))
        self.carDefault = py.transform.scale(self.carRaw, (210/5, 550/5))
        self.car = self.carDefault
        self.angle = 360
        self.carRect = self.car.get_rect()

        self.actualPosition = 1
        self.timeP = 0
        self.shapesP = []

    def intro(self):
        self.dt = time() - self.lastTime
        self.dt *= 60
        self.lastTime = time()
        
        for event in py.event.get():
            if event.type == py.QUIT:
                py.quit()
                sys.exit()
            if event.type == py.MOUSEBUTTONDOWN or event.type == py.KEYDOWN:
                self.state = "main_game"

        screen.fill((28, 155, 79))
        
        #py.draw.rect(screen, (28, 155, 79), (0, 680, 1280, 50))
        self.draw_lines()
        
        for cloud in self.clouds:
            cloud.move(screen, self.dt)

        opacity = py.Surface((screenWidth, screenHeight))
        opacity.set_alpha(150)
        opacity.fill((0, 0, 0))

        screen.blit(opacity, (0, 0))

        #draw_text("HUEHUETÉOTL", py.font.Font("assets/Pixellari.ttf", 70), (255, 255, 255), screen, center=True)
        draw_text("Presiona cualquier tecla para iniciar", py.font.Font("assets/Pixellari.ttf", 30), (255, 255, 255), screen, (screenWidth/2-235), (screenHeight/2+50))

    def main_game(self):
        self.dt = time() - self.lastTime
        self.dt *= 60
        self.lastTime = time()

        for event in py.event.get():
            if event.type == py.QUIT:
                py.quit()
                sys.exit()

        screen.fill((28, 155, 79))

        self.draw_lines()
        self.draw_car()

        for cloud in self.clouds:
            cloud.move(screen, self.dt)

    def draw_lines(self):
        for i in range(len(self.posX)-2):
            lineColor = "#4E5258"

            localX = self.posX[i] + (screenWidth/2) - 250
            localY = self.posY[i]

            nextX = self.posX[i+1] + (screenWidth/2) - 250
            nextY = self.posY[i+1]
            
            shape = py.draw.line(screen, lineColor, (localX, localY), (nextX, nextY), 80)
            self.shapesP.append(shape)

    def draw_car(self):
        localX = (self.posX[self.actualPosition] + (screenWidth/2) - 250) #* self.dt * 1
        localY = self.posY[self.actualPosition] #* self.dt * 1
        
        self.carRect = self.car.get_rect()
        self.carRect.center =  (localX, localY)

        screen.blit(self.car, self.carRect)

        #if py.time.get_ticks() - self.timeP > 10:
        if self.actualPosition <= len(self.posX) - 2:
            m = (self.posY[self.actualPosition+1]-self.posY[self.actualPosition])/(self.posX[self.actualPosition+1] - self.posX[self.actualPosition])
            angle = degrees(atan(m))

            self.angle = 180 - angle + 75.1608 + 15
            self.car = py.transform.rotate(self.carDefault, self.angle)
            self.actualPosition += 1

            #self.timeP = py.time.get_ticks()

    def state_manager(self):
        if self.state == "intro":
            self.intro()
        elif self.state == "main_game":
            self.main_game()
 
 
game_state = GameState()

while True:
    game_state.state_manager()
    
    py.display.flip()
    py.display.update()

    clock.tick(60)

#pygame.quit()